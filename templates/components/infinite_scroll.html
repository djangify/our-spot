<!-- In templates/components/infinite_scroll.html -->
<div id="infinite-scroll" data-url="{% url 'locations:locations' %}"></div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentPage = 1;
        let hasNextPage = {{ page_obj.has_next|yesno:"true,false" }};
        let isLoading = false;
        let maxPages = {{ page_obj.paginator.num_pages }};
        let loadedLocationIds = new Set();

        // Get all initial location IDs
        document.querySelectorAll('[data-location-id]').forEach(el => {
            loadedLocationIds.add(parseInt(el.dataset.locationId));
        });

        const locationFeed = document.getElementById('location-feed');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noMorePosts = document.getElementById('no-more-posts');

        if (!locationFeed || !loadingIndicator || !noMorePosts) {
            console.error('Missing required elements for infinite scroll');
            return;
        }

        function isNearBottom() {
            return window.innerHeight + window.scrollY >= document.body.offsetHeight - 500;
        }

        function loadMoreLocations() {
            if (isLoading || !hasNextPage) {
                if (!hasNextPage && noMorePosts.classList.contains('hidden')) {
                    noMorePosts.classList.remove('hidden');
                    loadingIndicator.classList.add('hidden');
                }
                return;
            }

            isLoading = true;
            loadingIndicator.classList.remove('hidden');
            currentPage++;

            const url = `?page=${currentPage}`;
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.location_ids && Array.isArray(data.location_ids)) {
                    const newContent = document.createElement('div');
                    newContent.innerHTML = data.html.trim();

                    let newItems = 0;
                    const fragments = document.createDocumentFragment();

                    Array.from(newContent.children).forEach(child => {
                        const locationId = parseInt(child.dataset.locationId);
                        if (locationId && !loadedLocationIds.has(locationId)) {
                            loadedLocationIds.add(locationId);
                            fragments.appendChild(child);
                            newItems++;
                        }
                    });

                    if (newItems > 0) {
                        locationFeed.appendChild(fragments);
                    } else {
                        console.log('No new locations to add - all were duplicates');
                    }
                } else {
                    locationFeed.insertAdjacentHTML('beforeend', data.html);
                }

                hasNextPage = data.has_next;
                maxPages = data.total_pages;

                if (!hasNextPage) {
                    noMorePosts.classList.remove('hidden');
                }

                loadingIndicator.classList.add('hidden');
                isLoading = false;
            })
            .catch(error => {
                console.error('Error loading more locations:', error);
                loadingIndicator.classList.add('hidden');
                noMorePosts.classList.remove('hidden');
                isLoading = false;
            });
        }

        let scrollTimer = null;
        window.addEventListener('scroll', function() {
            if (scrollTimer !== null) {
                clearTimeout(scrollTimer);
            }
            scrollTimer = setTimeout(function() {
                if (isNearBottom()) {
                    loadMoreLocations();
                }
            }, 200);
        });

        if (isNearBottom() && hasNextPage) {
            loadMoreLocations();
        }
    });
</script>