{% extends "base.html" %}
{% load thumbnail %}
<!-- Contains code that is added to each users profile-->
{% block title %}{{user.get_full_name}}{% endblock %}

{% block content %}

<h1>{{user.get_full_name}}</h1>

<div class="profile-info"> 
<img src="{{ user.profile.photo.url }}" class="user-detail">
</div>
{% with total_followers=user.followers.count %}
<span class="count">
<span class="total">{{total_followers}}</span>
follower{{total_followers|pluralize}}
</span>
<a href="#" data-id="{{ user.id }}" data-action=
"{% if request.user in user.followers.all %}un{% endif %}follow"
cla="follow button">
{% if request.user not in user.followers.all %}
Follow
{% else %}
Unfollow
{% endif %}
</a>
{% endwith %}
<!-- List of users added locations are included -->
<div class="container">
<h2>Recent Spots</h2>
<div class="row infinite-container">
{% for location in locations %}
<div class="infinite-item">
<a href="{{ location.get_absolute_url }}" class="image-detail"
aria-label="Click to view {{ location.title }}">
<img src="{{ location.image.url }}" alt="{{ location.image_alt }}"
style="max-width: 75%; height: auto;">
</a>
<br>
<h3>{{location.title}}</h3>
<p>{{location.description|truncatechars:100}}</p>
</div>
</a>
{% endfor %}
</div>
</div>
{% endblock %}

{% block domready %}
const url = '{% url "user_follow" %}'
var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
}

document.querySelector('a.follow')
.addEventListener('click', function(e){
    e.preventDefault()
    var followButton=this

    // add request body
    var formData=new FormData()
    formData.append('id', followButton.dataset.id)
    formData.append('action', followButton.dataset.action)
    options['body']=formData

    // send HTTP request
    fetch(url, options)
    .then(response=> response.json())
    .then(data=> {
         if (data['status'] ==='ok')
         {
            var previousAction=followButton.dataset.action

            // toggle button text and data-action
            var action=previousAction==='follow'?'unfollow': 'follow'
            followButton.dataset.action=action
            followButton.innerHTML=action

            // update follower count
            var followerCount=document.querySelector('span.count .total')
            var totalFollowers=parseInt(followerCount.innerHTML)
            followerCount.innerHTML=previousAction==='follow'?totalFollowers+1:
            totalFollowers-1
            }
    })
})
{% endblock %}
